#!/bin/bash

parse_args() {
  if [ "$#" -lt 2 ]; then
    echo "Usage: $0 <mountpoint> <command> [args...]"
    exit 1
  fi

  args_mnt="$1"
  shift
  args_cmd=("$@")
}

cleanup() {
  if [ -n "$child_pid" ] && kill -0 "$child_pid" 2>/dev/null; then
    kill -CONT "$child_pid" 2>/dev/null
    kill -INT "$child_pid" 2>/dev/null
  fi
  exit 0
}

get_free_gb() {
  # Returns free space in GB using stat
  local stats=$(stat -f -c "%S %a" "$args_mnt")
  local b_size=$(echo "$stats" | cut -d' ' -f1)
  local b_avail=$(echo "$stats" | cut -d' ' -f2)
  echo "$(( (b_size * b_avail) / 1024 / 1024 / 1024 ))"
}

monitor() {
  trap cleanup SIGTERM SIGINT

  "${args_cmd[@]}" &
  child_pid=$!
  local paused=0

  while kill -0 "$child_pid" 2>/dev/null; do
    local free_gb=$(get_free_gb)

    if (( free_gb < 20 )) && [ "$paused" -eq 0 ]; then
      kill -STOP "$child_pid"
      paused=1
      echo Paused "$child_pid"
    elif (( free_gb >= 30 )) && [ "$paused" -eq 1 ]; then
      kill -CONT "$child_pid"
      paused=0
      echo Unpaused "$child_pid"
    fi

    sleep 5
  done
}

parse_args "$@"
monitor
